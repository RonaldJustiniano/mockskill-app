<?xml version="1.0" encoding="UTF-8"?><record_update table="sc_cat_item_producer">
    <sc_cat_item_producer action="INSERT_OR_UPDATE">
        <access_type>restricted</access_type>
        <active>true</active>
        <allow_edit>false</allow_edit>
        <availability>on_desktop</availability>
        <billable>false</billable>
        <can_cancel>false</can_cancel>
        <category display_value="Bug">bc59a6cac36322104d7636dc05013122</category>
        <checked_out/>
        <cost>0</cost>
        <custom_cart/>
        <delivery_plan display_value="DEFAULT">523da512c611228900811a37c97c2014</delivery_plan>
        <delivery_plan_script/>
        <delivery_time>1970-01-03 00:00:00</delivery_time>
        <description/>
        <display_price_property>non_zero</display_price_property>
        <entitlement_script/>
        <flow_designer_flow/>
        <fulfillment_automation_level>unspecified</fulfillment_automation_level>
        <group/>
        <hide_sp>false</hide_sp>
        <icon/>
        <ignore_price>true</ignore_price>
        <image/>
        <location/>
        <make_item_non_conversational>false</make_item_non_conversational>
        <mandatory_attachment>false</mandatory_attachment>
        <meta/>
        <mobile_hide_price>false</mobile_hide_price>
        <mobile_picture/>
        <mobile_picture_type>use_desktop_picture</mobile_picture_type>
        <model/>
        <name>Reportar Bug em Lote</name>
        <no_attachment_v2>false</no_attachment_v2>
        <no_cart>false</no_cart>
        <no_cart_v2>false</no_cart_v2>
        <no_delivery_time_v2>false</no_delivery_time_v2>
        <no_order>false</no_order>
        <no_order_now>false</no_order_now>
        <no_proceed_checkout>false</no_proceed_checkout>
        <no_quantity>false</no_quantity>
        <no_quantity_v2>false</no_quantity_v2>
        <no_save_as_draft>false</no_save_as_draft>
        <no_search>false</no_search>
        <no_wishlist_v2>false</no_wishlist_v2>
        <omit_price>false</omit_price>
        <order>0</order>
        <ordered_item_link/>
        <owner display_value="System Administrator">6816f79cc0a8016401c5a33be04be441</owner>
        <picture/>
        <post_insert_script><![CDATA[/**
* This script is executed after the record is generated. 
* `current` Is the GlideRecord produced by Record Producer. Use `current.update()` to update the record
* To access the variables, use `producer.var1` where var1 is the name of the variable
* To access the Record Producer use `cat_item`
*/]]></post_insert_script>
        <preview>JavaScript: popupOpenStandard("com.glideapp.servicecatalog_cat_item_view.do?v=1&amp;sysparm_id=6b9c03f4c3676a504d7636dc050131ed&amp;sysparm_preview=true", "summary");</preview>
        <price>0</price>
        <published_ref/>
        <recurring_frequency/>
        <redirect_url>generated_record</redirect_url>
        <request_method/>
        <roles/>
        <save_options/>
        <save_script><![CDATA[/**
* This script is executed at every step save in Catalog Builder. 
* This script is executed before `Script` is executed.
* `current` Is the GlideRecord produced by Record Producer. 
* To access the variables, use `producer.var1` where var1 is the name of the variable
* To access the Record Producer use `cat_item`
*/]]></save_script>
        <sc_catalogs>e0d08b13c3330100c8b837659bba8fb4</sc_catalogs>
        <sc_ic_item_staging/>
        <sc_ic_version/>
        <sc_template/>
        <script><![CDATA[// Record Producer: Importar Bugs em Lote (robusto: ; ou , e sinônimos de cabeçalho)
// Target table: x_snc_mock_skillup_bug_lote
(function executeProducer(current, producer) {
  try {
    // 1) Salva o registro do lote (para receber o anexo)
    var loteSysId = current.insert();
    if (!loteSysId) { gs.addErrorMessage("Falha ao criar registro do lote."); return; }

    // 2) Localiza o último .csv anexado
    var att = new GlideRecord("sys_attachment");
    att.addQuery("table_name", "x_snc_mock_skillup_bug_lote");
    att.addQuery("table_sys_id", loteSysId);
    att.addQuery("file_name", "ENDSWITH", ".csv");
    att.orderByDesc("sys_created_on");
    att.setLimit(1);
    att.query();
    if (!att.next()) { gs.addErrorMessage("Nenhum CSV anexado."); return; }

    // 3) Lê o conteúdo do arquivo (UTF-8) e remove BOM
    var gsa = new GlideSysAttachment();
    var text = gsa.getContent(att);
    if (!text) { gs.addErrorMessage("Não foi possível ler o CSV."); return; }
    text = ("" + text).replace(/^\uFEFF/, "");

    // 4) Descobre delimitador (prioriza ';' se existir no header)
    var allLines = ("" + text).split(/\r?\n/).filter(function(ln){ return (ln || "").trim().length > 0; });
    if (allLines.length < 2) { gs.addErrorMessage("CSV vazio ou sem dados."); return; }

    var headerLine = allLines[0];
    var delimiter = headerLine.indexOf(";") > -1 ? ";" : ",";

    // 5) Parser de linha que respeita aspas e delimitadores dentro de aspas
    function parseLine(line, delim) {
      var out = [], cur = "", inQuote = false;
      for (var i = 0; i < line.length; i++) {
        var ch = line.charAt(i);
        if (ch === '"') {
          if (inQuote && i + 1 < line.length && line.charAt(i + 1) === '"') {
            cur += '"'; i++; // escape de aspas
          } else {
            inQuote = !inQuote;
          }
        } else if (ch === delim && !inQuote) {
          out.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    // 6) Normalizador de nomes de coluna
    function canon(s) {
      s = ("" + s).toLowerCase();
      s = s.replace(/['"`]/g, "");
      s = s.replace(/\s+/g, "");
      s = s.replace(/[^\w]/g, ""); // remove não-alfanumérico/_ 
      return s;
    }
    function findIndex(colsRaw, candidates) {
      for (var i = 0; i < colsRaw.length; i++) {
        var c = canon(colsRaw[i]);
        for (var j = 0; j < candidates.length; j++) {
          if (c === candidates[j]) return i;
        }
      }
      return -1;
    }

    var colsRaw = parseLine(headerLine, delimiter);
    var headerMsg = colsRaw.join(" | ");

    // Possíveis nomes (aceita PT/EN e variações)
    var idxShort = findIndex(colsRaw, ["short_description","shortdescription","summary","titulo","resumo","title"]);
    var idxDesc  = findIndex(colsRaw, ["description","descricao","descrição","details","detalhes"]);
    var idxPrio  = findIndex(colsRaw, ["priority","prioridade","prio"]);
    var idxState = findIndex(colsRaw, ["state","status","estado"]);
    var idxMail  = findIndex(colsRaw, ["assigned_to_email","assignedtoemail","assigneeemail","email","assigned_to","assignedto","assignee","username","user","login"]);

    if (idxShort === -1 || idxDesc === -1 || idxPrio === -1 || idxState === -1 || idxMail === -1) {
      gs.addErrorMessage("Cabeçalho inválido. Detectado: " + headerMsg + " | Delimitador: '" + delimiter + "'. " +
        "Esperado colunas equivalentes a: short_description; description; priority; state; assigned_to_email");
      return;
    }

    // 7) Helpers de normalização
    function normPriority(v) {
      if (!v) return "3 - Moderate";
      v = ("" + v).toLowerCase().trim();
      if (v.indexOf("1") === 0 || v.indexOf("critical") > -1 || v.indexOf("critica") > -1) return "1 - Critical";
      if (v.indexOf("2") === 0 || v.indexOf("high") > -1 || v.indexOf("alta") > -1)     return "2 - High";
      if (v.indexOf("3") === 0 || v.indexOf("moderate") > -1 || v.indexOf("normal") > -1 || v.indexOf("media") > -1 || v.indexOf("média") > -1) return "3 - Moderate";
      if (v.indexOf("4") === 0 || v.indexOf("low") > -1 || v.indexOf("baixa") > -1)     return "4 - Low";
      return "3 - Moderate";
    }
    function normState(v) {
      if (!v) return "Open"; // seu padrão
      v = ("" + v).toLowerCase().trim();
      if (v.indexOf("open") > -1 || v.indexOf("new") > -1 || v === "novo") return "Open";
      if (v.indexOf("progress") > -1 || v.indexOf("working") > -1)         return "In Progress";
      if (v.indexOf("hold") > -1 || v.indexOf("aguardo") > -1)             return "On Hold";
      if (v.indexOf("resolved") > -1 || v.indexOf("resolvido") > -1)       return "Resolved";
      if (v.indexOf("closed") > -1 || v.indexOf("fechado") > -1)           return "Closed";
      return "Open";
    }
    function findUser(val) {
      if (!val) return "";
      val = ("" + val).trim();
      var u = new GlideRecord("sys_user");
      if (val.indexOf("@") > -1) {
        u.addQuery("email", val);
      } else {
        // tenta user_name, depois name
        var q = u.addQuery("user_name", val);
        q.addOrCondition("name", val);
      }
      u.setLimit(1); u.query();
      if (u.next()) return u.getUniqueValue();
      gs.warn("Bug Import - usuário não encontrado: " + val);
      return "";
    }

    var inserted = 0, skipped = 0;

    // 8) Processa linhas de dados
    for (var r = 1; r < allLines.length; r++) {
      var raw = allLines[r];
      if (!raw || !raw.trim()) continue;

      var parts = parseLine(raw, delimiter);
      // garante tamanho
      while (parts.length < colsRaw.length) parts.push("");

      var sd   = (parts[idxShort] || "").trim();
      var desc = (parts[idxDesc]  || "").trim();
      var pri  = normPriority(parts[idxPrio]);
      var st   = normState(parts[idxState]);
      var who  = (parts[idxMail]  || "").trim();
      var assg = findUser(who);

      if (!sd) { skipped++; continue; }

      var bug = new GlideRecord("x_snc_mock_skillup_bug");
      bug.initialize();
      bug.short_description = sd;
      bug.description = desc;
      bug.priority = pri;
      bug.state = st;
      if (assg) bug.assigned_to = assg;

      if (bug.insert()) inserted++; else skipped++;
    }

    gs.addInfoMessage("Importação concluída: " + inserted + " inseridos, " + skipped + " ignorados. " +
      "Colunas detectadas: " + headerMsg + " | Delimitador: '" + delimiter + "'.");
  } catch (e) {
    gs.addErrorMessage("Erro no Producer (robusto): " + e.message);
  }
})(current, producer);
]]></script>
        <short_description/>
        <show_variable_help_on_load>false</show_variable_help_on_load>
        <start_closed>false</start_closed>
        <state/>
        <sys_class_name>sc_cat_item_producer</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-08-21 19:20:36</sys_created_on>
        <sys_id>6b9c03f4c3676a504d7636dc050131ed</sys_id>
        <sys_mod_count>16</sys_mod_count>
        <sys_name>Reportar Bug em Lote</sys_name>
        <sys_package display_value=" Mock SkillUp" source="x_snc_mock_skillup">389364c69f9322107f44bcf72024ab3f</sys_package>
        <sys_policy/>
        <sys_scope display_value=" Mock SkillUp">389364c69f9322107f44bcf72024ab3f</sys_scope>
        <sys_update_name>sc_cat_item_producer_6b9c03f4c3676a504d7636dc050131ed</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-08-25 13:57:40</sys_updated_on>
        <table_name>x_snc_mock_skillup_bug_lote</table_name>
        <taxonomy_topic/>
        <template/>
        <template_manager_roles/>
        <type>item</type>
        <use_sc_layout>true</use_sc_layout>
        <vendor/>
        <version>16</version>
        <view/>
        <visible_bundle>true</visible_bundle>
        <visible_guide>true</visible_guide>
        <visible_standalone>true</visible_standalone>
        <workflow/>
    </sc_cat_item_producer>
    <sys_translated_text action="delete_multiple" query="documentkey=6b9c03f4c3676a504d7636dc050131ed"/>
    <fx_price action="delete_multiple" query="id=6b9c03f4c3676a504d7636dc050131ed"/>
    <fx_price action="INSERT_OR_UPDATE">
        <amount>0</amount>
        <currency display_value="BRL">BRL</currency>
        <field>price</field>
        <id>6b9c03f4c3676a504d7636dc050131ed</id>
        <parent/>
        <reference_amount>0</reference_amount>
        <reference_currency display_value="USD">USD</reference_currency>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-08-21 19:20:36</sys_created_on>
        <sys_id>50fcc7f4c3676a504d7636dc050131af</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-08-21 19:20:36</sys_updated_on>
        <table>sc_cat_item_producer</table>
        <type>calculated</type>
    </fx_price>
</record_update>
